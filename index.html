
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>カンバンTODO v0.25</title>
    
    <!-- カスタムスタイル -->
    <link rel="stylesheet" href="src/custom/styles.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <!-- カスタム設定 -->
    <script type="module" src="src/custom/app-config.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 5px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 10px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        /* パネル表示モード切り替え */
        body.panel-mode .section-panel {
            position: relative;
            border: 3px solid #007bff;
            border-radius: 8px;
            padding: 5px 20px 20px 5px;
            margin: 15px 0;
            background: white;
            box-shadow: 0 2px 5px rgba(0,123,255,0.2);
        }
        body.panel-mode .panel-L {
            border: 3px solid #28a745;
            box-shadow: 0 2px 5px rgba(40,167,69,0.3);
        }
        body.panel-mode .panel-number {
            display: block;
            position: absolute;
            top: -15px;
            left: 15px;
            background: #007bff;
            color: white;
            padding: 2px 10px;
            font-weight: bold;
            font-size: 16px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 10;
        }
        
        /* 通常モード */
        body:not(.panel-mode) .section-panel {
            position: relative;
            padding: 10px;
            margin: 10px 0;
        }
        body:not(.panel-mode) .panel-number {
            display: none;
        }
        
        /* 階層サイズ */
        .panel-L { /* 大 */ }
        .panel-M { /* 中 */
            padding: 15px !important;
            border-width: 2px !important;
        }
        .panel-S { /* 小 */
            padding: 10px !important;
            border-width: 1px !important;
            margin: 5px 0 !important;
        }
        
        /* モード切り替えボタン */
        .mode-toggle {
            position: fixed;
            top: 10px;
            right: 140px;
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .mode-toggle:hover {
            background: #0056b3;
        }
        .grid-toggle {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 10000001;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .grid-toggle:hover {
            background: #218838;
        }
        
        /* グリッド表示モード（シンプル版） */
        body.grid-mode::before {
            content: "📐 グリッド表示モード";
            position: fixed;
            top: 50px;
            right: 10px;
            background: rgba(255,255,255,0.95);
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
            z-index: 1000001;
        }
        
        /* カンバンボードのレイアウト */
        .kanban-board-horizontal {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding: 10px 0;
        }
        
        .kanban-board-vertical {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 10px 0;
        }
        
        .kanban-board-vertical .kanban-column {
            width: 100% !important;
            min-width: unset !important;
        }
        
        /* 優先順位の色分け */
        .priority-S { border-left: 5px solid #dc3545 !important; }
        .priority-A { border-left: 5px solid #fd7e14 !important; }
        .priority-B { border-left: 5px solid #ffc107 !important; }
        .priority-C { border-left: 5px solid #28a745 !important; }
        
        .priority-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            color: white;
            margin-right: 5px;
        }
        
        .priority-badge-S { background: #dc3545; }
        .priority-badge-A { background: #fd7e14; }
        .priority-badge-B { background: #ffc107; color: #212529; }
        .priority-badge-C { background: #28a745; }
        
        /* スマホ対応 */
        @media (max-width: 768px) {
            body { padding: 3px; }
            .container { padding: 8px; margin: 0; border-radius: 0; }
            .weight-input { grid-template-columns: 1fr; gap: 8px; }
            .input-card { padding: 8px; }
            
            /* モバイルでは自動的に縦配置 */
            .kanban-board-horizontal {
                flex-direction: column;
            }
            
            .kanban-board-horizontal .kanban-column {
                width: 100% !important;
                min-width: unset !important;
            }
        }
        .auth-section { background: #e7f3ff; color: #0c5460; padding: 10px; border-radius: 5px; text-align: center; }
        .weight-input { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px; margin: 8px 0; }
        .input-card { border: 1px solid #ddd; padding: 8px; border-radius: 8px; }
        
        /* タイミングパネルのスタイル */
        .timing-panel { 
            background: #f8f9fa; 
            border: 2px solid #e9ecef; 
            border-radius: 8px; 
            padding: 8px; 
            margin: 5px 0; 
        }
        .timing-buttons { 
            display: flex; 
            gap: 4px; 
            flex-wrap: wrap; 
            justify-content: center;
        }
        .timing-btn { 
            background: #6c757d; 
            color: white; 
            border: none; 
            padding: 6px 8px; 
            border-radius: 12px; 
            cursor: pointer; 
            font-size: 11px;
            transition: all 0.2s;
            min-width: 70px;
            text-align: center;
        }
        .timing-btn:hover {
            transform: scale(1.05);
        }
        .timing-btn.selected {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        @media (max-width: 768px) {
            .timing-buttons { gap: 3px; }
            .timing-btn { 
                padding: 4px 6px; 
                font-size: 10px;
                min-width: 60px;
            }
        }
        .input-field { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin: 5px 0; font-size: 16px; }
        .save-button { background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; margin: 5px; font-size: 16px; }
        .save-button:hover { background: #218838; }
        .auth-button { background: #4285f4; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        .auth-button:hover { background: #357ae8; }
        .logout-button { background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; margin: 5px; }
        .data-area { background: #f8f9fa; border: 1px solid #dee2e6; padding: 8px; border-radius: 5px; font-family: monospace; min-height: 120px; }
        .hidden { display: none; }
        .user-info { background: #d4edda; color: #155724; padding: 6px; border-radius: 5px; margin-bottom: 8px; }
    </style>
</head>
<body class="panel-mode">
    <!-- ⚠️ 開発補助機能（削除禁止） -->
    <button class="mode-toggle" onclick="togglePanelMode()">📊 パネル表示</button>
    <button class="grid-toggle" onclick="toggleGridMode()">⊞ グリッド表示</button>
    <!-- 開発補助機能ここまで -->
    
    <div class="container">
        <!-- ⚠️ パネル1: 認証（削除禁止） -->
        <div class="section-panel panel-L" style="padding: 10px !important;">
            <span class="panel-number">[1]</span>
            <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                <h1 style="margin: 0; font-size: 16px;">📋 カンバンTODO v0.25</h1>
                <!-- 認証セクション -->
                <div id="authSection" style="display: flex; gap: 10px; align-items: center; margin-left: auto;">
                    <button class="auth-button" onclick="handleGoogleLogin()" style="padding: 6px 12px; margin: 0;">Googleログイン</button>
                </div>
                <!-- ユーザー情報表示 (ログイン後に表示) -->
                <div class="hidden" id="userInfo" style="display: flex; gap: 10px; align-items: center; margin-left: auto;">
                    <span style="font-size: 14px;">👤 <span id="userName"></span></span>
                    <button class="logout-button" onclick="handleLogout()" style="padding: 4px 10px; margin: 0; font-size: 12px;">ログアウト</button>
                </div>
            </div>
        </div>
        
        <!-- パネル2: カンバンボード -->
        <div class="section-panel panel-L hidden" id="userPanel">
            <span class="panel-number">[2]</span>
            
            <!-- 新規タスク追加セクション -->
            <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <h3 style="margin-top: 0; margin-bottom: 10px; font-size: 14px;">➕ 新しいタスク</h3>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <input type="text" id="taskTitle" placeholder="タスクタイトル（例：週次会議の準備）" class="input-field" style="margin: 0; width: 100%;">
                    <textarea id="taskDescription" placeholder="説明（オプション）" class="input-field" rows="2" style="margin: 0; width: 100%; resize: vertical;"></textarea>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <div style="display: flex; gap: 5px; align-items: center;">
                            <label style="font-weight: bold;">優先順位:</label>
                            <select id="priorityLevel" class="input-field" style="margin: 0; padding: 5px; width: 60px;">
                                <option value="S">S</option>
                                <option value="A" selected>A</option>
                                <option value="B">B</option>
                                <option value="C">C</option>
                            </select>
                            <select id="priorityNumber" class="input-field" style="margin: 0; padding: 5px; width: 60px;">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5" selected>5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10</option>
                            </select>
                        </div>
                        <button onclick="addTask()" class="save-button" style="margin: 0; padding: 10px 30px;">追加</button>
                    </div>
                </div>
            </div>
            
            <!-- フィルターセクション -->
            <div style="margin-bottom: 15px; padding: 10px; background: #e9ecef; border-radius: 8px;">
                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <label style="font-weight: bold; font-size: 12px;">フィルター:</label>
                    <button onclick="filterByPriority('all')" class="filter-btn" data-filter="all" style="background: #007bff; color: white; border: none; padding: 5px 13px; border-radius: 5px; cursor: pointer; font-size: 12px;">ALL</button>
                    <button onclick="filterByPriority('S')" class="filter-btn" data-filter="S" style="background: #dc3545; color: white; border: none; padding: 5px 13px; border-radius: 5px; cursor: pointer; font-size: 12px;">S</button>
                    <button onclick="filterByPriority('A')" class="filter-btn" data-filter="A" style="background: #fd7e14; color: white; border: none; padding: 5px 13px; border-radius: 5px; cursor: pointer; font-size: 12px;">A</button>
                    <button onclick="filterByPriority('B')" class="filter-btn" data-filter="B" style="background: #ffc107; color: #212529; border: none; padding: 5px 13px; border-radius: 5px; cursor: pointer; font-size: 12px;">B</button>
                    <button onclick="filterByPriority('C')" class="filter-btn" data-filter="C" style="background: #28a745; color: white; border: none; padding: 5px 13px; border-radius: 5px; cursor: pointer; font-size: 12px;">C</button>
                </div>
            </div>

            <!-- カンバンボード -->
            <div id="kanbanBoard" class="kanban-board-horizontal" style="display: flex; gap: 15px; overflow-x: auto; padding: 10px 0;">
                <!-- Todo列 -->
                <div class="kanban-column" style="flex: 1; min-width: 300px; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                    <h3 style="margin-top: 0; margin-bottom: 15px; color: #6c757d; text-align: center;">📋 Todo</h3>
                    <div id="todoColumn" class="task-list" data-status="todo" style="min-height: 300px;">
                        <!-- タスクカードがここに追加されます -->
                    </div>
                </div>
                
                <!-- Doing列 -->
                <div class="kanban-column" style="flex: 1; min-width: 300px; background: #e7f3ff; padding: 15px; border-radius: 8px;">
                    <h3 style="margin-top: 0; margin-bottom: 15px; color: #0066cc; text-align: center;">🔄 Doing</h3>
                    <div id="doingColumn" class="task-list" data-status="doing" style="min-height: 300px;">
                        <!-- タスクカードがここに追加されます -->
                    </div>
                </div>
                
                <!-- Done列 -->
                <div class="kanban-column" style="flex: 1; min-width: 300px; background: #d4edda; padding: 15px; border-radius: 8px;">
                    <h3 style="margin-top: 0; margin-bottom: 15px; color: #155724; text-align: center;">✅ Done</h3>
                    <div id="doneColumn" class="task-list" data-status="done" style="min-height: 300px;">
                        <!-- タスクカードがここに追加されます -->
                    </div>
                </div>
            </div>
        </div>

        <!-- ⚠️ パネル3: ログ（削除禁止） -->
        <div class="section-panel panel-L">
            <span class="panel-number">[3]</span>
            <h3>📋 アプリログ <button class="universal-copy-btn" onclick="copyLogs()" style="background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 12px;">📋 ログをコピー</button></h3>
            <div class="data-area" id="logArea">
            カンバンTODO v0.25 起動完了...<br>
            🔥 Firebase設定完了<br>
            🔐 Google認証準備完了<br>
            </div>
        </div>
        
        <!-- ⚠️ パネル4: デバッグボタン（削除禁止） -->
        <div class="section-panel panel-L" style="margin-top: 8px; text-align: center;">
            <span class="panel-number">[4]</span>
            <button class="universal-copy-btn" onclick="debugFirebaseConnection()" style="background: #ff6b6b; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 5px;">🔍 Firebase Debug</button>
            <button onclick="testGridAdjust()" style="background: #17a2b8; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 5px;">📐 Grid調整テスト</button>
            <button class="universal-copy-btn" onclick="checkLoginIssues()" style="background: #ffc107; color: #212529; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 5px;">⚠️ ログイン問題診断</button>
            <button class="universal-copy-btn" onclick="copyDebugInfo()" style="background: #17a2b8; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 5px;">📋 デバッグ情報をコピー</button>
            <button class="universal-copy-btn" onclick="checkDatabaseStructure()" style="background: #6f42c1; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 5px;">🏗️ DB構造確認</button>
            <button class="universal-copy-btn" onclick="checkMobileSupport()" style="background: #28a745; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 5px;">📱 モバイル診断</button>
            <button class="universal-copy-btn" onclick="forceAuthCheck()" style="background: #fd7e14; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 5px;">🔄 認証状態確認</button>
            <button class="universal-copy-btn" onclick="checkFirebaseConfig()" style="background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 5px;">🔧 Firebase設定</button>
            <button class="universal-copy-btn" onclick="testPopup()" style="background: #20c997; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 5px;">🧪 ポップアップテスト</button>
            <button class="universal-copy-btn" onclick="window.open('test-error.html', '_blank')" style="background: #e74c3c; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 5px;">🚨 エラーテスト</button>
        </div>
        
    </div>

    <script>
        // Core Firebase設定（変更禁止 - core/src/firebase-config.js参照）
        const firebaseConfig = {
            apiKey: "AIzaSyA5PXKChizYDCXF_GJ4KL6Ylq9K5hCPXWE",
            authDomain: "shares-b1b97.firebaseapp.com",
            databaseURL: "https://shares-b1b97-default-rtdb.firebaseio.com",
            projectId: "shares-b1b97",
            storageBucket: "shares-b1b97.firebasestorage.app",
            messagingSenderId: "38311063248",
            appId: "1:38311063248:web:0d2d5726d12b305b24b8d5"
        };

        // Firebase初期化
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        let currentUser = null;
        let selectedTimingValue = '';
        let draggedElement = null;
        let currentFilter = 'all';

        // タスク追加機能
        window.addTask = async () => {
            if (!currentUser) {
                log('❌ ログインが必要です');
                return;
            }

            const title = document.getElementById('taskTitle').value.trim();
            const description = document.getElementById('taskDescription').value.trim();
            const priorityLevel = document.getElementById('priorityLevel').value;
            const priorityNumber = document.getElementById('priorityNumber').value;

            if (!title) {
                log('❌ タスクタイトルを入力してください');
                return;
            }

            try {
                log('💾 タスクを保存中...');
                
                const taskData = {
                    title: title,
                    description: description || '',
                    status: 'todo',
                    priorityLevel: priorityLevel,
                    priorityNumber: parseInt(priorityNumber) || 5,
                    priority: `${priorityLevel}${priorityNumber}`,
                    userEmail: currentUser.email,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    createdAt: new Date().toISOString()
                };

                const userRef = database.ref(`users/${currentUser.uid}/tasks`);
                await userRef.push(taskData);
                log(`✅ タスク追加完了: ${title}`);
                
                // 入力フィールドをクリア
                document.getElementById('taskTitle').value = '';
                document.getElementById('taskDescription').value = '';
                document.getElementById('priorityLevel').value = 'A';
                document.getElementById('priorityNumber').value = '5';
                
                // データを再読み込み
                loadUserTasks(currentUser.uid);
            } catch (error) {
                log(`❌ 保存エラー: ${error.message}`);
            }
        };

        // タスクのステータス更新
        window.updateTaskStatus = async (taskId, newStatus) => {
            if (!currentUser) {
                log('❌ ログインが必要です');
                return;
            }
            
            try {
                log(`🔄 タスクステータス更新中: ${taskId} -> ${newStatus}`);
                const taskRef = database.ref(`users/${currentUser.uid}/tasks/${taskId}`);
                await taskRef.update({ status: newStatus });
                log(`✅ ステータス更新完了`);
            } catch (error) {
                log(`❌ 更新エラー: ${error.message}`);
            }
        };

        // タスク削除
        window.deleteTask = async (taskId) => {
            if (!currentUser) {
                log('❌ ログインが必要です');
                return;
            }
            
            if (!confirm('このタスクを削除しますか？')) {
                return;
            }
            
            try {
                log(`🗑️ タスク削除中: ${taskId}`);
                const taskRef = database.ref(`users/${currentUser.uid}/tasks/${taskId}`);
                await taskRef.remove();
                log(`✅ 削除完了`);
            } catch (error) {
                log(`❌ 削除エラー: ${error.message}`);
            }
        };

        // フィルター機能
        window.filterByPriority = (priority) => {
            currentFilter = priority;
            const allCards = document.querySelectorAll('.task-card');
            
            // フィルターボタンのスタイル更新
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if (btn.dataset.filter === priority) {
                    btn.style.opacity = '1';
                    btn.style.boxShadow = '0 4px 8px rgba(0,0,0,0.3)';
                } else {
                    btn.style.opacity = '0.6';
                    btn.style.boxShadow = 'none';
                }
            });
            
            allCards.forEach(card => {
                if (priority === 'all') {
                    card.style.display = 'block';
                } else {
                    const cardPriority = card.dataset.priorityLevel;
                    if (cardPriority === priority) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                }
            });
            
            log(`🔍 フィルター適用: ${priority === 'all' ? 'ALL' : priority}`);
        };

        // ドラッグ&ドロップのイベントハンドラ
        function handleDragStart(e) {
            console.log('Drag started:', e.target);
            const taskId = e.target.dataset.taskId;
            const taskTitle = e.target.querySelector('.task-content')?.textContent || 'Unknown';
            log(`🎯 ドラッグ開始: ${taskTitle} (ID: ${taskId})`);
            
            draggedElement = e.target;
            e.target.style.opacity = '0.5';
            e.target.style.cursor = 'grabbing';
            e.dataTransfer.effectAllowed = 'move';
            // データを設定しないことでブラウザのリンク動作を防ぐ
            try {
                e.dataTransfer.setData('text/html', '');
            } catch(err) {
                console.error('setData error:', err);
                log(`❌ ドラッグエラー: ${err.message}`);
            }
        }

        function handleDragEnd(e) {
            console.log('Drag ended');
            const taskTitle = e.target.querySelector('.task-content')?.textContent || 'Unknown';
            log(`🏁 ドラッグ終了: ${taskTitle}`);
            
            e.target.style.opacity = '';
            e.target.style.cursor = 'grab';
            draggedElement = null;
            // すべての列の背景をリセット
            document.querySelectorAll('.task-list').forEach(list => {
                list.style.background = '';
            });
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            
            // ログは頻繁すぎるのでコメントアウト
            // const status = e.currentTarget.dataset.status;
            // log(`➡️ ドラッグオーバー: ${status}列`);
            
            return false;
        }

        function handleDragEnter(e) {
            if (e.target.classList.contains('task-list')) {
                e.target.style.background = 'rgba(0,123,255,0.1)';
                const status = e.target.dataset.status;
                log(`📍 列に入った: ${status}`);
            }
        }

        function handleDragLeave(e) {
            if (e.target.classList.contains('task-list')) {
                e.target.style.background = '';
                const status = e.target.dataset.status;
                log(`👋 列から出た: ${status}`);
            }
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            
            if (e.target.classList.contains('task-list')) {
                e.target.style.background = '';
                const newStatus = e.target.dataset.status;
                const taskId = draggedElement.dataset.taskId;
                
                if (taskId && newStatus) {
                    updateTaskStatus(taskId, newStatus);
                }
            }
            
            return false;
        }

        // 認証状態の監視（改良版）
        auth.onAuthStateChanged((user) => {
            currentUser = user;
            if (user) {
                log(`✅ 認証状態確認: ${user.displayName} でログイン中`);
                log(`📧 メール: ${user.email}`);
                showUserInterface(user);
                loadUserTasks(user.uid);
            } else {
                log('🔒 認証状態: 未ログイン');
                showLoginInterface();
            }
        });

        // 初期化完了ログ
        log('🔄 Firebase認証システム初期化完了 - 認証状態を確認中...');

        // Googleログイン（改良版 - ポップアップブロック検知付き）
        window.handleGoogleLogin = async () => {
            try {
                log('🔐 Googleログイン開始...');
                const provider = new firebase.auth.GoogleAuthProvider();
                
                // モバイルデバイス検出（表示用）
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                
                if (isMobile) {
                    log('📱 モバイルデバイス検出 - ポップアップ方式でログイン');
                    log('💡 ポップアップが途中で止まる場合は、ブラウザ設定の確認が必要です');
                } else {
                    log('🖥️ デスクトップデバイス - ポップアップ方式でログイン');
                }
                
                // ポップアップブロック検知のためのタイムアウト設定
                log('🪟 ポップアップウィンドウでGoogleログインを開始...');
                
                const loginPromise = auth.signInWithPopup(provider);
                
                // タイムアウト検知（5秒でポップアップが開かない場合）
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => {
                        reject(new Error('ポップアップタイムアウト - ブロックされた可能性があります'));
                    }, 5000);
                });
                
                try {
                    const result = await Promise.race([loginPromise, timeoutPromise]);
                    log(`✅ ログイン成功: ${result.user.displayName}`);
                } catch (raceError) {
                    // タイムアウトの場合の特別処理
                    if (raceError.message.includes('タイムアウト')) {
                        log('⏰ ポップアップが5秒以内に開きませんでした');
                        log('🔄 ポップアップブロック検知 - 解決方法をご案内します');
                        throw new Error('POPUP_TIMEOUT');
                    } else {
                        throw raceError;
                    }
                }
                
            } catch (error) {
                log(`❌ ログインエラー: ${error.message}`);
                
                // エラーの詳細情報をログに出力
                if (error.code) {
                    log(`- エラーコード: ${error.code}`);
                    
                    // 特定のエラーコードに対する解決策を提示
                    switch(error.code) {
                        case 'auth/unauthorized-domain':
                            log('💡 ドメイン許可設定の問題です');
                            log('💡 Firebase Consoleで認証ドメインを確認してください');
                            break;
                        case 'auth/popup-blocked':
                            log('💡 ポップアップがブロックされました');
                            showPopupGuide(isMobile);
                            break;
                        case 'auth/popup-closed-by-user':
                            log('💡 ユーザーがポップアップを閉じました');
                            log('💡 もう一度ログインボタンを押してください');
                            break;
                        case 'auth/cancelled-popup-request':
                            log('💡 前回のポップアップがキャンセルされました');
                            log('💡 しばらく待ってから再試行してください');
                            break;
                        default:
                            if (error.message === 'POPUP_TIMEOUT') {
                                log('⚠️ ポップアップが途中で止まりました');
                                showPopupGuide(isMobile);
                            } else {
                                log('💡 ブラウザを更新してもう一度お試しください');
                            }
                    }
                } else if (error.message === 'POPUP_TIMEOUT') {
                    showPopupGuide(isMobile);
                }
                
                if (error.credential) {
                    log('- 認証情報は取得済み');
                }
            }
        };

        // ポップアップ許可ガイド表示
        function showPopupGuide(isMobile) {
            log('📖 === ポップアップ許可ガイド ===');
            if (isMobile) {
                log('📱 スマートフォン向け解決手順:');
                log('1. ページ上部のアドレスバーに表示される「ポップアップがブロックされました」をタップ');
                log('2. または、ブラウザメニュー(⋮) → 設定 → サイト設定 → ポップアップとリダイレクト → 許可');
                log('3. Chrome: 右上⋮メニュー → 設定 → 詳細設定 → サイト設定 → ポップアップとリダイレクト');
                log('4. Safari: 設定アプリ → Safari → ポップアップブロック → オフ');
                log('5. 設定後、このページを更新してもう一度ログインボタンを押してください');
            } else {
                log('💻 PC向け解決手順:');
                log('1. アドレスバー右端のアイコン(🚫)をクリック → 許可');
                log('2. または、ブラウザ設定 → プライバシーとセキュリティ → ポップアップとリダイレクト → 許可');
            }
            log('💡 それでも解決しない場合: プライベートモードを終了するか、別のブラウザをお試しください');
            log('🔄 ポップアップ設定を確認したら、再度「Googleでログイン」ボタンを押してください');
            log('📖 ========================');
        }

        // ポップアップテスト機能
        window.testPopup = () => {
            log('🧪 ポップアップテスト開始...');
            
            try {
                const testWindow = window.open('', '_blank', 'width=400,height=500');
                
                if (testWindow) {
                    log('✅ ポップアップ許可済み - ログイン可能です');
                    testWindow.close();
                    log('💡 「Googleでログイン」ボタンを押してください');
                } else {
                    log('❌ ポップアップがブロックされています');
                    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                    showPopupGuide(isMobile);
                }
            } catch (error) {
                log(`❌ ポップアップテストエラー: ${error.message}`);
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                showPopupGuide(isMobile);
            }
        };

        // ログアウト
        window.handleLogout = async () => {
            try {
                await auth.signOut();
                log('📤 ログアウト完了');
            } catch (error) {
                log(`❌ ログアウトエラー: ${error.message}`);
            }
        };

        // ユーザーのタスクを読み込み
        function loadUserTasks(userId) {
            const userRef = database.ref(`users/${userId}/tasks`);
            userRef.on('value', (snapshot) => {
                const data = snapshot.val();
                const todoColumn = document.getElementById('todoColumn');
                const doingColumn = document.getElementById('doingColumn');
                const doneColumn = document.getElementById('doneColumn');
                
                // 列をクリア
                todoColumn.innerHTML = '';
                doingColumn.innerHTML = '';
                doneColumn.innerHTML = '';
                
                if (data) {
                    const tasks = Object.entries(data)
                        .map(([key, value]) => ({ id: key, ...value }));
                    
                    // 優先順位でソート（S1が最高、C10が最低）
                    tasks.sort((a, b) => {
                        const priorityOrder = { 'S': 0, 'A': 1, 'B': 2, 'C': 3 };
                        const aLevel = priorityOrder[a.priorityLevel || 'C'];
                        const bLevel = priorityOrder[b.priorityLevel || 'C'];
                        const aNumber = a.priorityNumber || 10;
                        const bNumber = b.priorityNumber || 10;
                        
                        if (aLevel !== bLevel) return aLevel - bLevel;
                        return aNumber - bNumber;
                    });
                    
                    tasks.forEach(task => {
                        const taskCard = document.createElement('div');
                        taskCard.className = `task-card priority-${task.priorityLevel || 'C'}`;
                        taskCard.dataset.taskId = task.id;
                        taskCard.dataset.priorityLevel = task.priorityLevel || 'C';
                        taskCard.draggable = true;
                        taskCard.style.cssText = `
                            background: white;
                            border: 1px solid #dee2e6;
                            border-radius: 8px;
                            padding: 12px;
                            margin-bottom: 10px;
                            cursor: grab;
                            transition: transform 0.2s, box-shadow 0.2s;
                            user-select: none;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                            transition: all 0.3s;
                        `;
                        
                        const priorityBadgeClass = `priority-badge priority-badge-${task.priorityLevel || 'C'}`;
                        const priorityText = `${task.priorityLevel || 'C'}${task.priorityNumber || ''}`;
                        
                        taskCard.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="flex: 1; display: flex; align-items: center; gap: 8px;">
                                    <span class="${priorityBadgeClass}">${priorityText}</span>
                                    <span style="color: #333; font-weight: 500;">${task.title}</span>
                                </div>
                                <button onclick="deleteTask('${task.id}')" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">×</button>
                            </div>
                            ${task.description ? `<div style="margin-top: 4px; color: #666; font-size: 12px; padding-left: 8px;">${task.description}</div>` : ''}
                        `;
                        
                        // ドラッグイベントを設定
                        taskCard.addEventListener('dragstart', handleDragStart, false);
                        taskCard.addEventListener('dragend', handleDragEnd, false);
                        
                        // マウスオーバーで視覚的フィードバック
                        taskCard.addEventListener('mouseenter', (e) => {
                            if (!draggedElement) {
                                e.currentTarget.style.transform = 'scale(1.02)';
                                e.currentTarget.style.boxShadow = '0 4px 8px rgba(0,0,0,0.15)';
                            }
                        });
                        
                        taskCard.addEventListener('mouseleave', (e) => {
                            if (!draggedElement) {
                                e.currentTarget.style.transform = '';
                                e.currentTarget.style.boxShadow = '';
                            }
                        });
                        
                        // マウスダウンで掴んでいる感覚を追加
                        taskCard.addEventListener('mousedown', (e) => {
                            if (e.target.tagName !== 'BUTTON') {
                                e.currentTarget.style.cursor = 'grabbing';
                                const taskTitle = e.currentTarget.querySelector('.task-content')?.textContent || 'Unknown';
                                log(`🖱️ マウスダウン: ${taskTitle}`);
                                log(`  - draggable: ${e.currentTarget.draggable}`);
                                log(`  - タスクID: ${e.currentTarget.dataset.taskId}`);
                            }
                        });
                        
                        taskCard.addEventListener('mouseup', (e) => {
                            if (e.target.tagName !== 'BUTTON') {
                                e.currentTarget.style.cursor = 'grab';
                                const taskTitle = e.currentTarget.querySelector('.task-content')?.textContent || 'Unknown';
                                log(`🖱️ マウスアップ: ${taskTitle}`);
                            }
                        });
                        
                        // ドラッグ可能かチェック
                        if (!taskCard.draggable) {
                            log(`⚠️ タスクカードがdraggableではない: ${task.title}`);
                        }
                        
                        // クリックイベントを無効化（リンク動作を防ぐ）
                        taskCard.addEventListener('click', (e) => {
                            if (e.target.tagName !== 'BUTTON') {
                                e.preventDefault();
                                e.stopPropagation();
                            }
                        });
                        
                        // マウスダウンイベントでリンク動作をブロック
                        taskCard.addEventListener('mousedown', (e) => {
                            if (e.target.tagName !== 'BUTTON') {
                                e.preventDefault();
                            }
                        });
                        
                        // ステータスに応じて列に追加
                        if (task.status === 'todo') {
                            todoColumn.appendChild(taskCard);
                        } else if (task.status === 'doing') {
                            doingColumn.appendChild(taskCard);
                        } else if (task.status === 'done') {
                            doneColumn.appendChild(taskCard);
                        }
                    });
                    
                    log(`📋 タスク読み込み完了: ${tasks.length}件`);
                    
                    // ドラッグ機能の診断
                    const allCards = document.querySelectorAll('.task-card');
                    log(`🔍 ドラッグ診断: ${allCards.length}個のタスクカード`);
                    allCards.forEach((card, index) => {
                        if (!card.draggable) {
                            log(`  ❌ カード${index + 1}: draggable=false`);
                        }
                    });
                } else {
                    log('📋 タスク: データなし');
                }
                
                // ドロップイベントを列に設定
                [todoColumn, doingColumn, doneColumn].forEach(column => {
                    column.addEventListener('dragover', handleDragOver, false);
                    column.addEventListener('drop', handleDrop, false);
                    column.addEventListener('dragenter', handleDragEnter, false);
                    column.addEventListener('dragleave', handleDragLeave, false);
                });
            });
        }

        // UI表示制御
        function showUserInterface(user) {
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('userInfo').style.display = 'flex';
            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('userPanel').classList.remove('hidden');
            document.getElementById('userName').textContent = user.displayName;
        }

        function showLoginInterface() {
            document.getElementById('authSection').style.display = 'flex';
            document.getElementById('userInfo').style.display = 'none';
            document.getElementById('userPanel').classList.add('hidden');
        }

        // ログ出力関数
        function log(message) {
            const logArea = document.getElementById('logArea');
            const timestamp = new Date().toLocaleTimeString();
            logArea.innerHTML += `[${timestamp}] ${message}<br>`;
            logArea.scrollTop = logArea.scrollHeight;
            console.log(message);
        }

        // ログコピー機能
        window.copyLogs = () => {
            const logArea = document.getElementById('logArea');
            const logText = logArea.innerText || logArea.textContent;
            navigator.clipboard.writeText(logText).then(() => {
                alert('✅ ログをコピーしました');
            }).catch(() => {
                // fallback
                const textArea = document.createElement('textarea');
                textArea.value = logText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('✅ ログをコピーしました');
            });
        };

        // Firebase接続デバッグ
        window.debugFirebaseConnection = () => {
            log('🔍 === Firebase Debug 開始 ===');
            
            // 1. Firebase設定確認
            log(`🔥 Firebase Config確認:`);
            log(`- Project ID: ${firebaseConfig.projectId}`);
            log(`- Database URL: ${firebaseConfig.databaseURL}`);
            log(`- Auth Domain: ${firebaseConfig.authDomain}`);
            
            // 2. 認証状態確認
            if (currentUser) {
                log(`✅ 認証済みユーザー:`);
                log(`- UID: ${currentUser.uid.substring(0,8)}...`);
                log(`- Email: ${currentUser.email}`);
                log(`- 表示名: ${currentUser.displayName}`);
            } else {
                log('❌ 未認証状態');
            }
            
            // 3. 接続テスト
            const connectedRef = database.ref('.info/connected');
            connectedRef.once('value', (snapshot) => {
                const connected = snapshot.val();
                log(`🌐 Firebase接続状態: ${connected ? '接続中' : '未接続'}`);
                
                if (connected && currentUser) {
                    // データベーステスト
                    const testRef = database.ref(`users/${currentUser.uid}/test`);
                    testRef.set({
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        message: 'Connection test',
                        app: 'app-template'
                    }).then(() => {
                        log('✅ データベース書き込みテスト成功');
                    }).catch((error) => {
                        log(`❌ データベース書き込みエラー: ${error.message}`);
                        log(`- Error Code: ${error.code}`);
                    });
                }
            });
            
            log('🔍 === Firebase Debug 完了 ===');
        };

        // モバイル環境診断
        window.checkMobileSupport = () => {
            log('📱 === モバイル環境診断 開始 ===');
            
            const userAgent = navigator.userAgent;
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent);
            
            log(`🌐 ユーザーエージェント: ${userAgent}`);
            log(`📱 モバイルデバイス判定: ${isMobile ? 'モバイル' : 'デスクトップ'}`);
            
            // ブラウザ判定
            const isChrome = /Chrome/i.test(userAgent);
            const isSafari = /Safari/i.test(userAgent) && !/Chrome/i.test(userAgent);
            const isFirefox = /Firefox/i.test(userAgent);
            
            log(`🌐 ブラウザ: ${isChrome ? 'Chrome' : isSafari ? 'Safari' : isFirefox ? 'Firefox' : '不明'}`);
            
            // ログイン方式の推奨
            if (isMobile) {
                log('💡 モバイルの推奨設定:');
                log('- Googleログインはリダイレクト方式を使用');
                log('- ポップアップブロッカーの影響なし');
                log('- 認証後にページが再読み込みされます');
            }
            
            log('📱 === モバイル環境診断 完了 ===');
        };

        // Firebase設定診断
        window.checkFirebaseConfig = () => {
            log('🔧 === Firebase設定診断 開始 ===');
            
            // 現在のドメイン確認
            const currentDomain = window.location.hostname;
            const currentUrl = window.location.href;
            log(`🌐 現在のドメイン: ${currentDomain}`);
            log(`🔗 現在のURL: ${currentUrl}`);
            
            // Firebase設定情報
            log(`🔥 Firebase設定:`);
            log(`- Project ID: ${firebaseConfig.projectId}`);
            log(`- Auth Domain: ${firebaseConfig.authDomain}`);
            log(`- Database URL: ${firebaseConfig.databaseURL}`);
            
            // 認証ドメイン許可状況の推測
            if (currentDomain === 'muumuu8181.github.io') {
                log('✅ GitHub Pagesドメイン検出');
                log('💡 Firebase Consoleでこのドメインが許可されているか確認が必要');
            } else if (currentDomain === 'localhost' || currentDomain === '127.0.0.1') {
                log('✅ ローカルホスト検出');
                log('💡 通常は自動で許可されています');
            } else {
                log('⚠️ 不明なドメインです');
                log('💡 Firebase Consoleの認証設定で許可が必要かもしれません');
            }
            
            // モバイルブラウザでのリダイレクト制限確認
            const userAgent = navigator.userAgent;
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent);
            
            if (isMobile) {
                log('📱 モバイルブラウザ固有の制限:');
                log('- Safari: サードパーティCookieの制限あり');
                log('- Chrome Mobile: ポップアップの自動ブロック');
                log('- 解決策: リダイレクト方式またはポップアップ許可設定');
            }
            
            log('🔧 === Firebase設定診断 完了 ===');
        };

        // 認証状態の強制確認
        window.forceAuthCheck = () => {
            log('🔍 === 認証状態強制確認 開始 ===');
            
            const user = auth.currentUser;
            log(`🔐 Firebase認証状態: ${user ? `ログイン済み (${user.displayName})` : '未ログイン'}`);
            
            if (user) {
                log('✅ ユーザー画面を表示します');
                showUserInterface(user);
                loadUserTasks(user.uid);
            } else {
                log('❌ ログイン画面を表示します');
                showLoginInterface();
            }
            
            // 認証トークンの有効性確認
            if (user) {
                user.getIdToken(true).then(() => {
                    log('✅ 認証トークンは有効です');
                }).catch((tokenError) => {
                    log(`❌ 認証トークンエラー: ${tokenError.message}`);
                    log('💡 再ログインが必要かもしれません');
                });
            }
            
            log('🔍 === 認証状態強制確認 完了 ===');
        };

        // ログイン問題診断
        window.checkLoginIssues = () => {
            log('⚠️ === ログイン問題診断 開始 ===');
            
            // 1. プロトコルチェック
            const protocol = window.location.protocol;
            log(`🌐 現在のプロトコル: ${protocol}`);
            
            if (protocol === 'file:') {
                log('❌ 問題発見: file://プロトコルではGoogle認証が動作しません');
                log('✅ 解決方法:');
                log('  1. HTTPサーバー経由でアクセス');
                log('  2. chrome://flags で insecure origins を許可');
                log('  3. ローカルサーバー起動 (python -m http.server 8000)');
            } else if (protocol === 'https:' || protocol === 'http:') {
                log('✅ プロトコル: 問題なし');
            }
            
            // 2. Web Storage確認
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                log('✅ Web Storage: 利用可能');
            } catch (e) {
                log('❌ Web Storage: 無効');
                log('✅ 解決方法: ブラウザ設定でCookieを有効にしてください');
            }
            
            // 3. Firebaseライブラリ確認
            if (typeof firebase !== 'undefined') {
                log('✅ Firebase SDK: 読み込み済み');
                log(`- Firebase Version: ${firebase.SDK_VERSION || 'Unknown'}`);
            } else {
                log('❌ Firebase SDK: 読み込みエラー');
            }
            
            // 4. ドメイン確認
            const domain = window.location.hostname;
            log(`🏠 現在のドメイン: ${domain}`);
            
            if (domain === 'localhost' || domain === '127.0.0.1') {
                log('✅ ローカル開発: Firebase設定で許可が必要');
            }
            
            log('⚠️ === ログイン問題診断 完了 ===');
        };

        // データベース構造確認
        window.checkDatabaseStructure = async () => {
            if (!currentUser) {
                log('❌ ログインが必要です');
                return;
            }
            
            log('🏗️ === データベース構造確認 開始 ===');
            
            try {
                // 現在のユーザーのtasksデータ構造を確認
                const userRef = database.ref(`users/${currentUser.uid}/tasks`);
                const snapshot = await userRef.once('value');
                const data = snapshot.val();
                
                if (data) {
                    const entries = Object.keys(data);
                    log(`📊 現在のユーザー(${currentUser.email})のタスク:`);
                    log(`- タスク数: ${entries.length}件`);
                    log(`- 最新タスクID: ${entries[entries.length - 1]}`);
                    
                    // サンプルデータ構造を表示
                    const sampleEntry = data[entries[0]];
                    log(`- データ構造: ${JSON.stringify(sampleEntry, null, 2)}`);
                    
                    // ステータス別カウント
                    let todoCount = 0, doingCount = 0, doneCount = 0;
                    Object.values(data).forEach(task => {
                        if (task.status === 'todo') todoCount++;
                        else if (task.status === 'doing') doingCount++;
                        else if (task.status === 'done') doneCount++;
                    });
                    log(`- Todo: ${todoCount}件, Doing: ${doingCount}件, Done: ${doneCount}件`);
                } else {
                    log('📊 現在のユーザーにはタスクがありません');
                }
                
                // ルートレベルの構造確認（管理者権限が必要）
                try {
                    const rootRef = database.ref('users');
                    const rootSnapshot = await rootRef.once('value');
                    const allUsers = rootSnapshot.val();
                    
                    if (allUsers) {
                        const userCount = Object.keys(allUsers).length;
                        log(`👥 全体統計:`);
                        log(`- 登録ユーザー数: ${userCount}人`);
                        
                        let totalTasks = 0;
                        Object.values(allUsers).forEach(user => {
                            if (user.tasks) {
                                totalTasks += Object.keys(user.tasks).length;
                            }
                        });
                        log(`- 全体のタスク数: ${totalTasks}件`);
                    }
                } catch (error) {
                    log(`⚠️ 全体統計の取得に制限があります: ${error.message}`);
                }
                
            } catch (error) {
                log(`❌ 構造確認エラー: ${error.message}`);
            }
            
            log('🏗️ === データベース構造確認 完了 ===');
        };

        // デバッグ情報をコピー
        window.copyDebugInfo = () => {
            const debugInfo = `アプリテンプレート v0.24 デバッグ情報
=================================
タイムスタンプ: ${new Date().toLocaleString()}
URL: ${window.location.href}
プロトコル: ${window.location.protocol}
ドメイン: ${window.location.hostname}
ユーザーエージェント: ${navigator.userAgent}

Firebase設定:
- プロジェクトID: ${firebaseConfig.projectId}
- データベースURL: ${firebaseConfig.databaseURL}
- 認証ドメイン: ${firebaseConfig.authDomain}

認証状態: ${currentUser ? 'ログイン済み' : '未ログイン'}
${currentUser ? `- UID: ${currentUser.uid.substring(0,8)}...\n- Email: ${currentUser.email}\n- 表示名: ${currentUser.displayName}` : ''}

Firebase SDK: ${typeof firebase !== 'undefined' ? '読み込み済み' : '読み込みエラー'}
Web Storage: ${(() => {
    try {
        localStorage.setItem('test', 'test');
        localStorage.removeItem('test');
        return '利用可能';
    } catch (e) {
        return '無効';
    }
})()}

ログ内容:
${document.getElementById('logArea').innerText}`;

            navigator.clipboard.writeText(debugInfo).then(() => {
                alert('✅ デバッグ情報をコピーしました');
            }).catch(() => {
                // fallback
                const textArea = document.createElement('textarea');
                textArea.value = debugInfo;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('✅ デバッグ情報をコピーしました');
            });
        };

        // 初期化
        // パネルモード切り替え
        window.togglePanelMode = () => {
            document.body.classList.toggle('panel-mode');
            const btn = document.querySelector('.mode-toggle');
            if (document.body.classList.contains('panel-mode')) {
                btn.textContent = '📊 パネル表示';
                log('📊 パネル表示モード: ON');
            } else {
                btn.textContent = '📄 通常表示';
                log('📄 パネル表示モード: OFF');
            }
        };
        
        // グリッドモード切り替え
        window.toggleGridMode = () => {
            const hasGridMode = document.body.classList.contains('grid-mode');
            log(`現在のグリッドモード: ${hasGridMode ? 'ON' : 'OFF'}`);
            
            document.body.classList.toggle('grid-mode');
            const btn = document.querySelector('.grid-toggle');
            
            if (document.body.classList.contains('grid-mode')) {
                btn.textContent = '□ グリッドOFF';
                btn.style.background = '#dc3545';
                log('⊞ グリッド表示モード: ON に切り替え');
                createGridOverlay();
            } else {
                btn.textContent = '⊞ グリッド表示';
                btn.style.background = '#28a745';
                log('□ グリッド表示モード: OFF に切り替え');
                removeGridOverlay();
            }
        };
        
        // グリッドオーバーレイ作成（シンプル版）
        function createGridOverlay() {
            // 既存のオーバーレイを削除
            removeGridOverlay();
            
            const overlay = document.createElement('div');
            overlay.className = 'grid-overlay';
            overlay.id = 'gridOverlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                pointer-events: none !important;
                z-index: 10000000;
            `;
            
            // グリッド設定
            const gridSize = 30; // ピクセル単位
            const maxCols = Math.ceil(window.innerWidth / gridSize);
            const maxRows = Math.min(100, Math.ceil(window.innerHeight / gridSize)); // 最大100行
            
            // Excel風の列ラベル生成関数
            function getColumnLabel(index) {
                let label = '';
                let num = index;
                while (num >= 0) {
                    label = String.fromCharCode(65 + (num % 26)) + label;
                    num = Math.floor(num / 26) - 1;
                    if (num < 0) break;
                }
                return label;
            }
            
            // グリッド線を追加
            for (let i = 0; i <= maxCols; i++) {
                // 垂直線
                const vLine = document.createElement('div');
                vLine.style.cssText = `
                    position: absolute;
                    left: ${i * gridSize}px;
                    top: 0;
                    width: 1px;
                    height: 100%;
                    background: rgba(40,167,69,0.2);
                    pointer-events: none;
                    z-index: 999998;
                `;
                overlay.appendChild(vLine);
            }
            
            for (let i = 0; i <= maxRows; i++) {
                // 水平線
                const hLine = document.createElement('div');
                hLine.style.cssText = `
                    position: absolute;
                    left: 0;
                    top: ${i * gridSize}px;
                    width: 100%;
                    height: 1px;
                    background: rgba(40,167,69,0.2);
                    pointer-events: none;
                    z-index: 999998;
                `;
                overlay.appendChild(hLine);
            }
            
            // ラベルを追加（すべてのグリッドに表示）
            for (let row = 0; row <= maxRows; row++) {
                for (let col = 0; col <= maxCols; col++) {
                    if (row === 0 || col === 0) {
                        const label = document.createElement('div');
                        label.className = 'grid-number';
                        label.style.cssText = `
                            position: absolute;
                            font-size: 10px;
                            color: rgba(40,167,69,0.9);
                            font-weight: bold;
                            background: rgba(255,255,255,0.95);
                            padding: 1px 3px;
                            border-radius: 2px;
                            pointer-events: none;
                            z-index: 999999;
                        `;
                        
                        if (row === 0 && col > 0) {
                            // 上部に列ラベル（A,B,C...Z,AA,AB...）
                            label.textContent = getColumnLabel(col - 1);
                            label.style.left = `${col * gridSize - 10}px`;
                            label.style.top = '2px';
                            overlay.appendChild(label);
                        } else if (col === 0 && row > 0) {
                            // 左側に行番号（1,2,3...100）
                            label.textContent = row.toString();
                            label.style.left = '2px';
                            label.style.top = `${row * gridSize - 10}px`;
                            overlay.appendChild(label);
                        }
                    }
                }
            }
            
            document.body.appendChild(overlay);
        }
        
        function removeGridOverlay() {
            const overlay = document.getElementById('gridOverlay');
            if (overlay) overlay.remove();
        }
        
        // グリッド位置調整ヘルパー関数
        window.adjustGridPosition = (selector, gridCode, adjustment) => {
            // gridCode例: "B4-C" (列B, 行4-C範囲)
            // adjustment例: 0.5 (0.5グリッド分短く/小さく)
            const element = document.querySelector(selector);
            if (!element) {
                log(`❌ 要素が見つかりません: ${selector}`);
                return;
            }
            
            // グリッドコードの解析 (例: "B4" → 列B(2), 行4)
            const match = gridCode.match(/^([A-T])(\d+)(?:-([A-T])?(\d+)?)?$/);
            if (!match) {
                log(`❌ 無効なグリッドコード: ${gridCode}`);
                return;
            }
            
            const startCol = match[1].charCodeAt(0) - 'A'.charCodeAt(0) + 1;
            const startRow = parseInt(match[2]);
            const endCol = match[3] ? match[3].charCodeAt(0) - 'A'.charCodeAt(0) + 1 : startCol;
            const endRow = match[4] ? parseInt(match[4]) : startRow;
            
            // グリッド単位をピクセルに変換（30pxが1グリッド）
            const gridWidth = 30;
            const gridHeight = 30;
            
            // 現在のスタイルを取得
            const currentStyle = window.getComputedStyle(element);
            const currentWidth = parseFloat(currentStyle.width);
            const currentHeight = parseFloat(currentStyle.height);
            
            // 調整を適用
            if (adjustment < 0) {
                // マイナス調整 = 短く/小さく
                element.style.width = `${currentWidth + (adjustment * gridWidth)}px`;
                element.style.height = `${currentHeight + (adjustment * gridHeight)}px`;
            } else {
                // プラス調整 = 長く/大きく
                element.style.width = `${currentWidth + (adjustment * gridWidth)}px`;
                element.style.height = `${currentHeight + (adjustment * gridHeight)}px`;
            }
            
            log(`✅ グリッド調整完了: ${selector} @ ${gridCode} (${adjustment > 0 ? '+' : ''}${adjustment}グリッド)`);
        };
        
        // グリッド位置取得ヘルパー関数
        window.getGridPosition = (selector) => {
            const element = document.querySelector(selector);
            if (!element) {
                log(`❌ 要素が見つかりません: ${selector}`);
                return null;
            }
            
            const rect = element.getBoundingClientRect();
            const gridCol = Math.floor(rect.left / 30);
            const gridRow = Math.floor(rect.top / 30);
            
            const colLetter = String.fromCharCode('A'.charCodeAt(0) + gridCol);
            const position = `${colLetter}${gridRow + 1}`;
            
            log(`📍 グリッド位置: ${selector} → ${position}`);
            return position;
        };
        
        // グリッド調整テスト関数
        window.testGridAdjust = () => {
            log('📐 === グリッド調整テスト開始 ===');
            
            // パネルレベルの要素を見つけて調整
            const testElement = document.querySelector('[data-grid="B3"]');
            if (testElement) {
                log('🎯 B3パネル要素を発見');
                
                // 元のサイズを記録
                const originalWidth = testElement.offsetWidth;
                const originalHeight = testElement.offsetHeight;
                log(`📏 元のサイズ: ${originalWidth}x${originalHeight}px`);
                
                // 0.5グリッド分調整
                adjustGridPosition('[data-grid="B3"]', 'B3', -0.5);
                
                // 新しいサイズを確認
                const newWidth = testElement.offsetWidth;
                const newHeight = testElement.offsetHeight;
                log(`📏 新しいサイズ: ${newWidth}x${newHeight}px`);
                log(`📊 変化量: 幅${newWidth - originalWidth}px, 高さ${newHeight - originalHeight}px`);
                
                // 3秒後に元に戻す
                setTimeout(() => {
                    adjustGridPosition('[data-grid="B3"]', 'B3', 0.5);
                    log('🔄 元のサイズに復元しました');
                }, 3000);
                
                log('⏱️ 3秒後に自動的に元のサイズに戻ります');
            } else {
                log('❌ B3パネル要素が見つかりません');
                log('💡 グリッド表示をONにして、要素の位置を確認してください');
            }
            
            log('📐 === テスト終了 ===');
        };
        
        log('🚀 カンバンTODO v0.25 起動完了');
        log('🔐 認証システム準備完了');
        
        // プロトコルチェック（自動診断）
        if (window.location.protocol === 'file:') {
            log('⚠️ file://プロトコル検出 - Googleログインには HTTPサーバーが必要です');
            log('💡 解決方法: python -m http.server 8000 または chrome://flags設定');
        }
    </script>
</body>
</html>
